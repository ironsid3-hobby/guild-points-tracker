<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guild Points Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">
    <header class="bg-gray-800 p-4 text-center text-2xl font-bold">
      Guild Points Tracker
    </header>

    <main class="flex flex-1 p-4 gap-4">
      <!-- Leaderboard -->
      <section
        class="flex-[2] bg-gray-800 p-4 rounded-2xl shadow-lg overflow-y-auto"
      >
        <h2 class="text-xl font-semibold mb-3">🏆 Leaderboard</h2>
        <table class="w-full text-left border-collapse" id="leaderboardTable">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="py-2">Player</th>
              <th class="py-2 text-right">Points</th>
              <th class="py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>

        <h3 class="text-lg font-semibold mt-6 mb-2">🧾 Claim History</h3>
        <table class="w-full text-left border-collapse" id="claimHistoryTable">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="py-2">Player</th>
              <th class="py-2">Item</th>
              <th class="py-2 text-right">Points Used</th>
              <th class="py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="claimHistoryBody"></tbody>
        </table>
      </section>

      <!-- Right Panel -->
      <aside
        class="flex-[1] bg-gray-800 p-4 rounded-2xl shadow-lg flex flex-col gap-4"
      >
        <!-- Paste Player Log -->
        <div class="flex flex-col flex-1">
          <h2 class="text-lg font-semibold mb-2">📋 Paste Player Log</h2>
          <textarea
            id="logInput"
            class="flex-1 w-full bg-gray-900 text-gray-100 p-2 rounded-lg resize-none"
            placeholder="Paste player names here (one per line)..."
          ></textarea>
          <button
            id="processLog"
            class="bg-blue-600 hover:bg-blue-700 mt-2 py-2 rounded-lg font-semibold"
          >
            Process Log
          </button>
        </div>

        <!-- Paste CSV Log -->
        <div class="flex flex-col flex-1">
          <h2 class="text-lg font-semibold mb-2">📊 Paste CSV (Name, Points)</h2>
          <textarea
            id="csvInput"
            class="flex-1 w-full bg-gray-900 text-gray-100 p-2 rounded-lg resize-none"
            placeholder="Example:
Player1, 10
Player2, 20"
          ></textarea>
          <button
            id="processCSV"
            class="bg-green-600 hover:bg-green-700 mt-2 py-2 rounded-lg font-semibold"
          >
            Import CSV
          </button>
        </div>

        <!-- Warning -->
        <div
          id="caseWarning"
          class="hidden text-yellow-400 text-sm bg-gray-900 p-2 rounded-lg"
        >
          ⚠️ Possible typo detected (case-insensitive match found).
        </div>
      </aside>
    </main>

    <!-- JS Logic -->
    <script>
      const leaderboardBody = document.getElementById("leaderboardBody");
      const claimHistoryBody = document.getElementById("claimHistoryBody");
      const caseWarning = document.getElementById("caseWarning");

      let players = JSON.parse(localStorage.getItem("players") || "{}");
      let claimHistory = JSON.parse(localStorage.getItem("claimHistory") || "[]");

      const saveData = () => {
        localStorage.setItem("players", JSON.stringify(players));
        localStorage.setItem("claimHistory", JSON.stringify(claimHistory));
      };

      const normalizeName = (name) => name.trim();

      const renderLeaderboard = () => {
        leaderboardBody.innerHTML = "";
        Object.entries(players)
          .sort((a, b) => b[1].points - a[1].points)
          .forEach(([name, player]) => {
            const row = document.createElement("tr");
            row.className = "border-b border-gray-700";
            row.innerHTML = `
              <td class="py-2">${name}</td>
              <td class="py-2 text-right">${player.points}</td>
              <td class="py-2 text-center">
                <button class="bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded text-sm mr-1 claim-btn" data-name="${name}">Claim</button>
                <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm delete-player" data-name="${name}">🗑</button>
              </td>
            `;
            leaderboardBody.appendChild(row);
          });
      };

      const renderClaimHistory = () => {
        claimHistoryBody.innerHTML = "";
        claimHistory.forEach((claim, i) => {
          const row = document.createElement("tr");
          row.className = "border-b border-gray-700";
          row.innerHTML = `
            <td class="py-2">${claim.name}</td>
            <td class="py-2">${claim.item}</td>
            <td class="py-2 text-right">${claim.pointsUsed}</td>
            <td class="py-2 text-center">
              <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm delete-claim" data-index="${i}">🗑</button>
            </td>
          `;
          claimHistoryBody.appendChild(row);
        });
      };

      // Handle player log paste
      document.getElementById("processLog").addEventListener("click", () => {
        const lines = document
          .getElementById("logInput")
          .value.split("\n")
          .map((x) => x.trim())
          .filter((x) => x);

        let typoDetected = false;

        lines.forEach((name) => {
          const normalized = normalizeName(name);
          const existingKey = Object.keys(players).find(
            (k) => k.toLowerCase() === normalized.toLowerCase()
          );

          if (existingKey && existingKey !== normalized) {
            typoDetected = true;
          }

          if (!existingKey) {
            players[normalized] = { points: 0 };
          }
        });

        caseWarning.classList.toggle("hidden", !typoDetected);
        saveData();
        renderLeaderboard();
        document.getElementById("logInput").value = "";
      });

      // Handle CSV import
      document.getElementById("processCSV").addEventListener("click", () => {
        const csvText = document.getElementById("csvInput").value.trim();
        if (!csvText) return;

        const lines = csvText.split("\n");
        lines.forEach((line) => {
          const [rawName, rawPoints] = line.split(",").map((x) => x.trim());
          if (!rawName || isNaN(parseFloat(rawPoints))) return;

          const name = normalizeName(rawName);
          const points = parseFloat(rawPoints);
          if (!players[name]) {
            players[name] = { points };
          } else {
            players[name].points += points;
          }
        });

        saveData();
        renderLeaderboard();
        document.getElementById("csvInput").value = "";
      });

      // Handle clicks
      document.body.addEventListener("click", (e) => {
        // Claim button
        if (e.target.classList.contains("claim-btn")) {
          const name = e.target.dataset.name;
          const pointsUsed = parseInt(
            prompt(`Enter how many points ${name} will use:`)
          );
          const item = prompt("Enter item name:");
          if (!pointsUsed || !item) return;

          if (players[name].points < pointsUsed) {
            alert("Not enough points!");
            return;
          }

          players[name].points -= pointsUsed;
          claimHistory.push({ name, item, pointsUsed });
          saveData();
          renderLeaderboard();
          renderClaimHistory();
        }

        // Delete player
        if (e.target.classList.contains("delete-player")) {
          const name = e.target.dataset.name;
          if (confirm(`Delete ${name} from leaderboard?`)) {
            delete players[name];
            saveData();
            renderLeaderboard();
          }
        }

        // Delete claim log
        if (e.target.classList.contains("delete-claim")) {
          const index = e.target.dataset.index;
          if (confirm("Delete this claim entry?")) {
            claimHistory.splice(index, 1);
            saveData();
            renderClaimHistory();
          }
        }
      });

      renderLeaderboard();
      renderClaimHistory();
    </script>
  </body>
</html>
