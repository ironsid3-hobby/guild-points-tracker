<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guild Points Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">
    <header class="bg-gray-800 p-4 text-center text-2xl font-bold">
      Guild Points Tracker
    </header>

    <main class="flex flex-1 p-4 gap-4">
      <!-- Leaderboard -->
      <section
        class="flex-[2] bg-gray-800 p-4 rounded-2xl shadow-lg overflow-y-auto"
      >
        <h2 class="text-xl font-semibold mb-3">🏆 Leaderboard</h2>
        <table class="w-full text-left border-collapse" id="leaderboardTable">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="py-2">Player</th>
              <th class="py-2 text-right">Points</th>
              <th class="py-2 text-center">Action</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>

        <h3 class="text-lg font-semibold mt-6 mb-2">🧾 Claim History</h3>
        <table class="w-full text-left border-collapse" id="claimHistoryTable">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="py-2">Player</th>
              <th class="py-2">Item</th>
              <th class="py-2 text-right">Points Used</th>
              <th class="py-2 text-center">Delete</th>
            </tr>
          </thead>
          <tbody id="claimHistoryBody"></tbody>
        </table>
      </section>

      <!-- Right panel: Paste logs -->
      <aside class="w-1/3 bg-gray-800 p-4 rounded-2xl shadow-lg flex flex-col">
        <h2 class="text-xl font-semibold mb-3">📋 Paste Player Logs</h2>

        <label class="text-sm font-semibold mb-1">Paste player names:</label>
        <textarea
          id="logInput"
          class="w-full bg-gray-900 text-gray-100 p-2 rounded-lg resize-none mb-2 h-28"
          placeholder="Paste player names here (one per line)..."
        ></textarea>

        <div class="flex items-center gap-2 mb-3">
          <input
            id="manualPoints"
            type="number"
            placeholder="Points to add"
            class="w-1/2 bg-gray-900 text-gray-100 p-2 rounded-lg"
          />
          <button
            id="processLog"
            class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold"
          >
            Process Log
          </button>
        </div>

        <div
          id="caseWarning"
          class="hidden mb-3 text-yellow-400 text-sm bg-gray-900 p-2 rounded-lg"
        >
          ⚠️ Possible typo detected (case-insensitive match found).
        </div>

        <hr class="my-3 border-gray-700" />

        <h2 class="text-xl font-semibold mb-3">📂 Paste CSV (Name,Points)</h2>
        <textarea
          id="csvInput"
          class="flex-1 w-full bg-gray-900 text-gray-100 p-2 rounded-lg resize-none h-32"
          placeholder="Paste CSV data (e.g. Player1,10)"
        ></textarea>
        <button
          id="processCSV"
          class="bg-green-600 hover:bg-green-700 mt-3 py-2 rounded-lg font-semibold"
        >
          Import CSV
        </button>
      </aside>
    </main>

    <script>
      const leaderboardBody = document.getElementById("leaderboardBody");
      const claimHistoryBody = document.getElementById("claimHistoryBody");
      const logInput = document.getElementById("logInput");
      const processLog = document.getElementById("processLog");
      const csvInput = document.getElementById("csvInput");
      const processCSV = document.getElementById("processCSV");
      const manualPoints = document.getElementById("manualPoints");
      const caseWarning = document.getElementById("caseWarning");

      let players = JSON.parse(localStorage.getItem("players")) || {};
      let claimHistory = JSON.parse(localStorage.getItem("claimHistory")) || [];

      function saveData() {
        localStorage.setItem("players", JSON.stringify(players));
        localStorage.setItem("claimHistory", JSON.stringify(claimHistory));
      }

      function renderLeaderboard() {
        leaderboardBody.innerHTML = "";
        const sortedPlayers = Object.entries(players).sort(
          (a, b) => b[1] - a[1]
        );
        for (const [name, points] of sortedPlayers) {
          const tr = document.createElement("tr");
          tr.className = "border-b border-gray-700";
          tr.innerHTML = `
            <td class="py-2">${name}</td>
            <td class="py-2 text-right">${points}</td>
            <td class="py-2 text-center">
              <button class="bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded text-sm mr-1" onclick="claimItem('${name}')">Claim</button>
              <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm" onclick="deletePlayer('${name}')">🗑️</button>
            </td>`;
          leaderboardBody.appendChild(tr);
        }
      }

      function renderClaimHistory() {
        claimHistoryBody.innerHTML = "";
        claimHistory.forEach((c, i) => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-gray-700";
          tr.innerHTML = `
            <td class="py-2">${c.name}</td>
            <td class="py-2">${c.item}</td>
            <td class="py-2 text-right">${c.pointsUsed}</td>
            <td class="py-2 text-center">
              <button class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm" onclick="deleteClaim(${i})">🗑️</button>
            </td>`;
          claimHistoryBody.appendChild(tr);
        });
      }

      function processPlayerLog() {
        const lines = logInput.value.trim().split("\n");
        const pts = parseInt(manualPoints.value || 0);
        let caseIssue = false;

        lines.forEach((line) => {
          const name = line.trim();
          if (!name) return;

          const existingName = Object.keys(players).find(
            (n) => n.toLowerCase() === name.toLowerCase()
          );
          if (existingName && existingName !== name) caseIssue = true;

          const finalName = existingName || name;
          players[finalName] = (players[finalName] || 0) + pts;
        });

        caseWarning.classList.toggle("hidden", !caseIssue);
        saveData();
        renderLeaderboard();
        logInput.value = "";
        manualPoints.value = "";
      }

      function processCSVInput() {
        const lines = csvInput.value.trim().split("\n");
        lines.forEach((line) => {
          const [name, points] = line.split(",").map((x) => x.trim());
          if (name && !isNaN(points)) {
            players[name] = (players[name] || 0) + parseInt(points);
          }
        });
        saveData();
        renderLeaderboard();
        csvInput.value = "";
      }

      function claimItem(name) {
        const pointsUsed = parseInt(prompt(`Enter points to use for ${name}:`));
        const item = prompt("Enter item name:");
        if (!pointsUsed || !item) return;
        if (players[name] < pointsUsed)
          return alert("Not enough points to claim.");
        players[name] -= pointsUsed;
        claimHistory.push({ name, item, pointsUsed });
        saveData();
        renderLeaderboard();
        renderClaimHistory();
      }

      function deletePlayer(name) {
        if (confirm(`Remove ${name} from leaderboard?`)) {
          delete players[name];
          saveData();
          renderLeaderboard();
        }
      }

      function deleteClaim(index) {
        if (confirm("Delete this claim log?")) {
          claimHistory.splice(index, 1);
          saveData();
          renderClaimHistory();
        }
      }

      processLog.addEventListener("click", processPlayerLog);
      processCSV.addEventListener("click", processCSVInput);

      renderLeaderboard();
      renderClaimHistory();
    </script>
  </body>
</html>
